{% extends "base.html" %}

{% block content %}
  <table id="data" class="table table-striped">
    <thead>
      <tr>
        <th>ID</th>
        <th>Description</th>
        <th>Label A</th>
        <th>Label B</th>
        <th>Predicted</th>
        <!--<th>Hide</th>-->  <!--TODO add this back later-->
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
{% endblock %}

{% block scripts %}
  <script>
    function modify_table() {
      console.log("Add to table...");
      // 1. Add checkboxes to the table for LabelA, LabelB, and Hide
      // 2. Make checkboxes checked or unchecked depending on the value of the relevant <td>
      //get all table rows and loop through skipping the first - there's one extra
        for (let i = 1; i < $('tr').length; i++) {
          tds = $('tr')[i].children

          // don't run this code if there are no rows drawn
	  if (tds.length == $('tr')[0].children.length) {
	    // Checkbox for labelA
            var checkboxA = document.createElement('input');
            checkboxA.type = 'checkbox';
            //checkboxA.row_on_page = i;
	    //checkboxA.label = 'A';
            //checkboxA.artwork_id = tds[0].textContent;
	    checkboxA.id = 'A'.concat(tds[0].textContent); 
            if (tds[2].textContent == 1) {
	      checkboxA.checked=true;
	      tds[2].textContent = '';
	    }
            tds[2].appendChild(checkboxA.cloneNode());

	    // Checkbox for labelB
	    var checkboxB = document.createElement('input');
	    checkboxB.type = 'checkbox';
            //checkboxB.row_on_page = i;
	    //checkboxB.label = 'B';
            //checkboxB.artwork_id = tds[0].textContent;
	    checkboxB.id = 'B'.concat(tds[0].textContent); 
            if (tds[3].textContent == 1) {
	      checkboxB.checked=true;
	      tds[3].textContent = '';
	    }
            tds[3].appendChild(checkboxB.cloneNode());

	    //todo add this back later
	    // button / icon for 'Hide'
	    //var button_icon = document.createElement('button');
	    //button_icon.classList.add("btn");
	    //var hide_icon = document.createElement('i');
	    //hide_icon.classList.add('bi');
	    //hide_icon.classList.add('bi-eye-slash');
	    //button_icon.appendChild(hide_icon);
	    //tds[5].appendChild(button_icon.cloneNode());
          }
	}
        // add onclicks
        checkboxes = $('input:checkbox')
	classifier_code = new URL(window.location.href).searchParams.get("classifier_code")
	for (let i = 0; i < checkboxes.length; i++) {
	  checkboxes[i].onclick = function() {
	  var jsondata = JSON.stringify({
	    "classifier_code": classifier_code,
	    "id": this.id,
	  });
	  $('input:checkbox').prop('disabled', true);
	  $('button').attr('disabled', true)
	  $.ajax({
	      type: "POST",
	      url: "check_label",
	      data: jsondata,
	      contentType: "application/json",
	      dataType: 'json',
	      success: function(response) {
		$('input:checkbox').prop('disabled', false);
		$('button').attr('disabled', false)
		if (typeof(response.unset) != 'undefined') {
		  checkbox_id = '#'.concat(response.unset.concat(response.id))
		  $(checkbox_id).prop('checked',false)
		}
		//alert('it completed');
	      }
	   });
	  }
	}
        //end add onclicks
    }


    $(document).ready(function() {
      classifier_code = new URL(window.location.href).searchParams.get("classifier_code")
      ajax_string = '/api/data?classifier_code='.concat(classifier_code)
      $('#data').DataTable({
        "initComplete": function(settings, json) {
         5+3;//  do nothing here. modify_table(); call on 'draw' instead
        },
        ajax: ajax_string,
        serverSide: true,
        columns: [
          {data: 'id'},
          {data: 'description'},
          {data: 'labelA'},
          {data: 'labelB'},
          {data: 'predicted'},
          //{data: 'hide'} TODO add this back later
        ],
      });
      // 1. Add checkboxes to the table for LabelA, LabelB, and Hide
    });

    $('#data').on( 'draw.dt', function () {
      modify_table();
    })
  </script>
{% endblock %}ยง
